from typing import List

SPB_METRO = {
    "–ö—Ä–∞—Å–Ω–∞—è": [
        "–î–µ–≤—è—Ç–∫–∏–Ω–æ", "–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∏–π –ø—Ä–æ—Å–ø–µ–∫—Ç", "–ê–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∞—è",
        "–ü–æ–ª–∏—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è", "–ü–ª–æ—â–∞–¥—å –ú—É–∂–µ—Å—Ç–≤–∞", "–õ–µ—Å–Ω–∞—è", "–í—ã–±–æ—Ä–≥—Å–∫–∞—è",
        "–ü–ª–æ—â–∞–¥—å –õ–µ–Ω–∏–Ω–∞", "–ß–µ—Ä–Ω—ã—à–µ–≤—Å–∫–∞—è", "–ü–ª–æ—â–∞–¥—å –í–æ—Å—Å—Ç–∞–Ω–∏—è", "–í–ª–∞–¥–∏–º–∏—Ä—Å–∫–∞—è",
        "–ü—É—à–∫–∏–Ω—Å–∫–∞—è", "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∏–Ω—Å—Ç–∏—Ç—É—Ç", "–ë–∞–ª—Ç–∏–π—Å–∫–∞—è", "–ù–∞—Ä–≤—Å–∫–∞—è",
        "–ö–∏—Ä–æ–≤—Å–∫–∏–π –∑–∞–≤–æ–¥", "–ê–≤—Ç–æ–≤–æ", "–õ–µ–Ω–∏–Ω—Å–∫–∏–π –ø—Ä–æ—Å–ø–µ–∫—Ç", "–ü—Ä–æ—Å–ø–µ–∫—Ç –í–µ—Ç–µ—Ä–∞–Ω–æ–≤"
    ],

    "–°–∏–Ω—è—è": [
        "–ü–∞—Ä–Ω–∞—Å", "–ü—Ä–æ—Å–ø–µ–∫—Ç –ü—Ä–æ—Å–≤–µ—â–µ–Ω–∏—è", "–û–∑–µ—Ä–∫–∏", "–£–¥–µ–ª—å–Ω–∞—è", "–ü–∏–æ–Ω–µ—Ä—Å–∫–∞—è",
        "–ß—ë—Ä–Ω–∞—è —Ä–µ—á–∫–∞", "–ü–µ—Ç—Ä–æ–≥—Ä–∞–¥—Å–∫–∞—è", "–ì–æ—Ä—å–∫–æ–≤—Å–∫–∞—è", "–ù–µ–≤—Å–∫–∏–π –ø—Ä–æ—Å–ø–µ–∫—Ç",
        "–°–µ–Ω–Ω–∞—è –ø–ª–æ—â–∞–¥—å", "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∏–Ω—Å—Ç–∏—Ç—É—Ç", "–§—Ä—É–Ω–∑–µ–Ω—Å–∫–∞—è",
        "–ú–æ—Å–∫–æ–≤—Å–∫–∏–µ –≤–æ—Ä–æ—Ç–∞", "–≠–ª–µ–∫—Ç—Ä–æ—Å–∏–ª–∞", "–ü–∞—Ä–∫ –ü–æ–±–µ–¥—ã", "–ú–æ—Å–∫–æ–≤—Å–∫–∞—è",
        "–ó–≤—ë–∑–¥–Ω–∞—è", "–ö—É–ø—á–∏–Ω–æ"
    ],

    "–ó–µ–ª—ë–Ω–∞—è": [
        "–ü—Ä–∏–º–æ—Ä—Å–∫–∞—è", "–í–∞—Å–∏–ª–µ–æ—Å—Ç—Ä–æ–≤—Å–∫–∞—è", "–ì–æ—Å—Ç–∏–Ω—ã–π –¥–≤–æ—Ä", "–ú–∞—è–∫–æ–≤—Å–∫–∞—è",
        "–ü–ª–æ—â–∞–¥—å –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∞ –ù–µ–≤—Å–∫–æ–≥–æ", "–ï–ª–∏–∑–∞—Ä–æ–≤—Å–∫–∞—è", "–õ–æ–º–æ–Ω–æ—Å–æ–≤—Å–∫–∞—è",
        "–ü—Ä–æ–ª–µ—Ç–∞—Ä—Å–∫–∞—è", "–û–±—É—Ö–æ–≤–æ", "–†—ã–±–∞—Ü–∫–æ–µ"
    ],

    "–û—Ä–∞–Ω–∂–µ–≤–∞—è": [
        "–°–ø–∞—Å—Å–∫–∞—è", "–î–æ—Å—Ç–æ–µ–≤—Å–∫–∞—è", "–õ–∏–≥–æ–≤—Å–∫–∏–π –ø—Ä–æ—Å–ø–µ–∫—Ç",
        "–ü–ª–æ—â–∞–¥—å –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∞ –ù–µ–≤—Å–∫–æ–≥–æ", "–ù–æ–≤–æ—á–µ—Ä–∫–∞—Å—Å–∫–∞—è",
        "–õ–∞–¥–æ–∂—Å–∫–∞—è", "–ü—Ä–æ—Å–ø–µ–∫—Ç –ë–æ–ª—å—à–µ–≤–∏–∫–æ–≤", "–£–ª–∏—Ü–∞ –î—ã–±–µ–Ω–∫–æ"
    ],

    "–§–∏–æ–ª–µ—Ç–æ–≤–∞—è": [
        "–ö–æ–º–µ–Ω–¥–∞–Ω—Ç—Å–∫–∏–π –ø—Ä–æ—Å–ø–µ–∫—Ç", "–°—Ç–∞—Ä–∞—è –î–µ—Ä–µ–≤–Ω—è", "–ö—Ä–µ—Å—Ç–æ–≤—Å–∫–∏–π –æ—Å—Ç—Ä–æ–≤",
        "–ß–∫–∞–ª–æ–≤—Å–∫–∞—è", "–°–ø–æ—Ä—Ç–∏–≤–Ω–∞—è", "–ê–¥–º–∏—Ä–∞–ª—Ç–µ–π—Å–∫–∞—è", "–°–∞–¥–æ–≤–∞—è",
        "–ó–≤–µ–Ω–∏–≥–æ—Ä–æ–¥—Å–∫–∞—è", "–û–±–≤–æ–¥–Ω—ã–π –∫–∞–Ω–∞–ª", "–í–æ–ª–∫–æ–≤—Å–∫–∞—è", "–ë—É—Ö–∞—Ä–µ—Å—Ç—Å–∫–∞—è",
        "–ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–∞—è", "–ü—Ä–æ—Å–ø–µ–∫—Ç –°–ª–∞–≤—ã", "–î—É–Ω–∞–π—Å–∫–∞—è", "–®—É—à–∞—Ä—ã"
    ]
}

EMODJI = {
    "–ö—Ä–∞—Å–Ω–∞—è": "üî¥",
    "–°–∏–Ω—è—è": "üîµ",
    "–ó–µ–ª—ë–Ω–∞—è": "üü¢",
    "–û—Ä–∞–Ω–∂–µ–≤–∞—è": "üü†",
    "–§–∏–æ–ª–µ—Ç–æ–≤–∞—è": "üü£"
}

BENEFIT_NAMES = {
        'regional': '–†–µ–≥–∏–æ–Ω–∞–ª—å–Ω–∞—è –ª—å–≥–æ—Ç–∞',
        'federal': '–§–µ–¥–µ—Ä–∞–ª—å–Ω–∞—è –ª—å–≥–æ—Ç–∞',
        'ssz': '–°–µ—Ä–¥–µ—á–Ω–æ-—Å–æ—Å—É–¥–∏—Å—Ç—ã–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è',
        'psychiatry': '–ü—Å–∏—Ö–∏–∞—Ç—Ä–∏—á–µ—Å–∫–∞—è –ª—å–≥–æ—Ç–∞',
        'refugee': '–õ—å–≥–æ—Ç–∞ –¥–ª—è –±–µ–∂–µ–Ω—Ü–µ–≤',
        'diabetic_kids_2_4': '–î–µ—Ç–∏ —Å –¥–∏–∞–±–µ—Ç–æ–º 2-4 –≥–æ–¥–∞',
        'diabetic_kids_4_17': '–î–µ—Ç–∏ —Å –¥–∏–∞–±–µ—Ç–æ–º 4-17 –ª–µ—Ç',
        'hepatitis': '–ì–µ–ø–∞—Ç–∏—Ç'
    }


async def get_station_emoji(station_name: str) -> str:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —ç–º–æ–¥–∑–∏ —Ü–≤–µ—Ç–∞ –≤–µ—Ç–∫–∏ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é —Å—Ç–∞–Ω—Ü–∏–∏.
    """
    for line_color, stations in SPB_METRO.items():
        if station_name in stations:
            return EMODJI.get(line_color, '‚ö™Ô∏è')

    return 'üöÉ'


async def format_update_time(last_update) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –≤—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è"""
    months = (
        '', '—è–Ω–≤–∞—Ä—è', '—Ñ–µ–≤—Ä–∞–ª—è', '–º–∞—Ä—Ç–∞', '–∞–ø—Ä–µ–ª—è', '–º–∞—è', '–∏—é–Ω—è',
        '–∏—é–ª—è', '–∞–≤–≥—É—Å—Ç–∞', '—Å–µ–Ω—Ç—è–±—Ä—è', '–æ–∫—Ç—è–±—Ä—è', '–Ω–æ—è–±—Ä—è', '–¥–µ–∫–∞–±—Ä—è'
    )

    return '{} {} {} {:02d}:{:02d}'.format(
        last_update.day, months[last_update.month],
        last_update.year, last_update.hour, last_update.minute
    )


async def get_maps_url(address: str) -> str:
    main_url = 'https://maps.yandex.ru/maps/?text='
    return main_url + address


async def format_benefits(pharmacy: dict) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫—É —Å –ª—å–≥–æ—Ç–∞–º–∏"""
    benefits = [
        f'{BENEFIT_NAMES[key]} - <b>{count} —à—Ç.</b>'
        for key, count in pharmacy.items()
        if key in BENEFIT_NAMES and count > 0
    ]
    return '\n'.join(benefits)


async def prepare_pharmacy_data(data: List[dict]) -> List[dict]:
    """
    –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ—Ç –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –∞–ø—Ç–µ–∫.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.
    """
    formatted_data = []
    for d in data:
        formatted_data.append({
            'name': d['pharm_name'],
            'maps_url': await get_maps_url(d['pharm_loc']),
            'location': d['pharm_loc'],
            'district': d['pharm_district'],
            'subway': f"{await get_station_emoji(d['pharm_subway'])} {d['pharm_subway']}",
            'phone': '+7812' + d['pharm_phone'],
            'time': await format_update_time(d['last_update']),
            'schedule': '\n'.join(
                f'‚Ä¢ {day}: {time}'
                for day, time in d['pharm_work'].items()
                if time != '0:00-0:00'
            ),
            'benefits': await format_benefits(d),
            'separator': "‚îÖ" * 20
        })
    return formatted_data


async def build_pharmacy_message(pharmacy_data: dict) -> str:
    """
    –°–æ–±–∏—Ä–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
    –ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å —Å –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –æ–¥–Ω–æ–π –∞–ø—Ç–µ–∫–∏.
    """
    return (
        f'\n<b>{pharmacy_data["name"]}</b>, '
        f'<a href="{pharmacy_data["maps_url"]}">'
        f'üìç{pharmacy_data["location"]}</a>\n'
        f'{pharmacy_data["district"]} —Ä–∞–π–æ–Ω, '
        f'{pharmacy_data["subway"]}\n'
        f'‚òéÔ∏è {pharmacy_data["phone"]}\n'
        f'<i>–î–∞–Ω–Ω—ã–µ –æ—Ç {pharmacy_data["time"]}</i>\n'
        f'<blockquote expandable>'
        f'{pharmacy_data["benefits"]}\n'
        f'\n –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –ª—å–≥–æ—Ç–Ω–æ–≥–æ –æ—Ç–¥–µ–ª–∞:\n'
        f'{pharmacy_data["schedule"]}'
        f'</blockquote>\n'
        f'{pharmacy_data["separator"]}'
    )


async def prettify_info(data: List[dict]) -> str:
    """
    –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏ —Å–æ–±–∏—Ä–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è.
    """
    formatted_data = await prepare_pharmacy_data(data)
    messages = [await build_pharmacy_message(d) for d in formatted_data]
    return ''.join(messages)
